<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil - iFinance</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ifinance.ico') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='ifinance.ico') }}">
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-left">
      <a href="{{ url_for('home') }}" class="brand-link" title="Ir para o início">
        <img class="navbar-icon" src="{{ url_for('static', filename='ifinance.ico') }}" alt="iFinance">
        <span class="navbar-title">iFinance</span>
      </a>
    </div>

    <div class="navbar-right">
      <span class="navbar-email"><b>{{ current_user.nome }}</b></span>
      <a class="btn btn-light" href="{{ url_for('logout') }}" style="text-decoration:none;">Sair</a>
    </div>
  </nav>

  <div class="app-shell">
    <div style="max-width:700px; margin:0 auto;">
      
      <!-- Título -->
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
        <a href="{{ url_for('home') }}" class="btn btn-light" style="padding:8px 12px;">← Voltar</a>
        <h1 style="margin:0; font-size:28px; font-weight:900;">Meu Perfil</h1>
      </div>

      <!-- Alertas -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat,msg in messages %}
            <div class="alert {% if cat=='error' %}alert-error{% elif cat=='ok' %}alert-ok{% else %}alert-info{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Card de Perfil -->
      <div class="panel" style="margin-bottom:20px;">
        <div style="text-align:center; padding:20px;">
          <!-- Foto de Perfil -->
          <div style="margin-bottom:20px;">
            {% if current_user.foto_perfil %}
              <img src="{{ url_for('static', filename='uploads/' + current_user.foto_perfil) }}" 
                   alt="Foto de perfil" 
                   id="previewFoto"
                   style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid rgba(255,255,255,.1);">
            {% else %}
              <div id="previewFoto" style="width:120px; height:120px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:48px; font-weight:900; color:#fff; border:4px solid rgba(255,255,255,.1);">
                {{ current_user.nome[0].upper() if current_user.nome else 'U' }}
              </div>
            {% endif %}
          </div>

          <h2 style="margin:8px 0 4px; font-size:24px; font-weight:900;">{{ current_user.nome }}</h2>
          <p style="margin:0; color:var(--muted); font-size:14px;">{{ current_user.email }}</p>
          <p style="margin:8px 0 0; color:var(--muted); font-size:12px; opacity:.7;">
            Membro desde {{ current_user.created_at.strftime('%d/%m/%Y') }}
          </p>
        </div>
      </div>

      <!-- Formulário de Edição -->
      <div class="panel">
        <div style="padding:20px;">
          <h3 style="margin:0 0 20px; font-size:18px; font-weight:900;">Editar Perfil</h3>

          <form method="POST" enctype="multipart/form-data">
            
            <!-- Foto de Perfil -->
            <div class="field">
              <label for="foto_perfil">Foto de perfil</label>
              <input type="file" id="foto_perfil" name="foto_perfil" accept="image/*" onchange="previewImage(event)">
              <p style="font-size:12px; color:var(--muted); margin:6px 0 0;">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP (máx. 5MB)</p>
            </div>

            <!-- Nome -->
            <div class="field">
              <label for="nome">Nome de usuário</label>
              <input type="text" id="nome" name="nome" value="{{ current_user.nome }}" required>
            </div>

            <!-- Email -->
            <div class="field">
              <label for="email">Email</label>
              <input type="email" id="email" name="email" value="{{ current_user.email }}" required>
            </div>

            <hr style="border:0; border-top:1px solid rgba(255,255,255,.08); margin:24px 0;">

            <h4 style="margin:0 0 14px; font-size:16px; font-weight:800; opacity:.9;">Alterar Senha (opcional)</h4>

            <!-- Senha Atual -->
            <div class="field">
              <label for="senha_atual">Senha atual</label>
              <input type="password" id="senha_atual" name="senha_atual" autocomplete="current-password">
            </div>

            <!-- Nova Senha -->
            <div class="field">
              <label for="nova_senha">Nova senha</label>
              <input type="password" id="nova_senha" name="nova_senha" autocomplete="new-password">
              <p style="font-size:12px; color:var(--muted); margin:6px 0 0;">Mínimo 6 caracteres</p>
            </div>

            <!-- Confirmar Senha -->
            <div class="field">
              <label for="confirmar_senha">Confirmar nova senha</label>
              <input type="password" id="confirmar_senha" name="confirmar_senha" autocomplete="new-password">
            </div>

            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
              <a href="{{ url_for('home') }}" class="btn btn-light">Cancelar</a>
              <button type="submit" class="btn btn-primary">Salvar alterações</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  <script>
    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('previewFoto');
          if (preview.tagName === 'IMG') {
            preview.src = e.target.result;
          } else {
            // Se for div (primeira vez), criar img
            const img = document.createElement('img');
            img.id = 'previewFoto';
            img.src = e.target.result;
            img.style.cssText = 'width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid rgba(255,255,255,.1);';
            preview.parentNode.replaceChild(img, preview);
          }
        };
        reader.readAsDataURL(file);
      }
    }
  </script>

</body>
</html>
